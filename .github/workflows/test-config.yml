name: ğŸ§ª æµ‹è¯•é…ç½®

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  test-wecom-notification:
    name: æµ‹è¯•ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ§ª æµ‹è¯•ä¼ä¸šå¾®ä¿¡ Webhook
        env:
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
        run: |
          echo "ğŸš€ å¼€å§‹æµ‹è¯•ä¼ä¸šå¾®ä¿¡é€šçŸ¥..."
          
          # ä¼˜å…ˆä½¿ç”¨ WECOM_WEBHOOK_URLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ WECHAT_WEBHOOK_URL
          WEBHOOK_URL="${WECOM_WEBHOOK_URL:-$WECHAT_WEBHOOK_URL}"
          
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªé…ç½® WECOM_WEBHOOK_URL æˆ– WECHAT_WEBHOOK_URL"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          
          echo "âœ… Webhook URL å·²é…ç½®"
          
          # å‘é€æµ‹è¯•æ¶ˆæ¯
          response=$(curl -s -w "\n%{http_code}" "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "## âœ… GitHub Actions æµ‹è¯•é€šçŸ¥\n\n> **ä»“åº“**: '"$GITHUB_REPOSITORY"'\n> **åˆ†æ”¯**: '"$GITHUB_REF_NAME"'\n> **æäº¤**: `'"${GITHUB_SHA:0:7}"'`\n> **è§¦å‘äºº**: @'"$GITHUB_ACTOR"'\n> **æ—¶é—´**: '"$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"'\n\n---\n\nâœ… **ä¼ä¸šå¾®ä¿¡é€šçŸ¥é…ç½®æ­£å¸¸**\n\n[æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }')
          
          # æå–çŠ¶æ€ç å’Œå“åº”ä½“
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“Š HTTP çŠ¶æ€ç : $http_code"
          echo "ğŸ“ å“åº”å†…å®¹: $body"
          echo ""
          
          # æ£€æŸ¥ç»“æœ
          if [ "$http_code" = "200" ]; then
            errcode=$(echo "$body" | grep -o '"errcode":[0-9]*' | cut -d':' -f2)
            if [ "$errcode" = "0" ]; then
              echo "âœ… é€šçŸ¥å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥ä¼ä¸šå¾®ä¿¡ç¾¤"
              exit 0
            else
              echo "âŒ å‘é€å¤±è´¥ï¼é”™è¯¯ç : $errcode"
              echo ""
              echo "å¸¸è§é”™è¯¯ç ï¼š"
              echo "  - 93000: æ–‡ä»¶ä¸å­˜åœ¨/æ— æ•ˆçš„ media_id"
              echo "  - 301002: æ— æ•ˆçš„ webhook keyï¼ˆè¯·æ£€æŸ¥ URL æ˜¯å¦å®Œæ•´ï¼‰"
              echo "  - 45009: æ¥å£è°ƒç”¨è¶…è¿‡é™åˆ¶"
              exit 1
            fi
          else
            echo "âŒ HTTP è¯·æ±‚å¤±è´¥ï¼çŠ¶æ€ç : $http_code"
            exit 1
          fi

  test-qianwen-api:
    name: æµ‹è¯•åƒé—® API
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ§ª æµ‹è¯•åƒé—® API Key
        env:
          QIANWEN_API_KEY: ${{ secrets.QIANWEN_API_KEY }}
        run: |
          echo "ğŸš€ å¼€å§‹æµ‹è¯•åƒé—® API..."
          
          if [ -z "$QIANWEN_API_KEY" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªé…ç½® QIANWEN_API_KEY"
            echo "è¯·åœ¨ Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          
          echo "âœ… API Key å·²é…ç½®"
          
          # æµ‹è¯• API è°ƒç”¨
          response=$(curl -s -w "\n%{http_code}" \
            'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation' \
            -H "Authorization: Bearer $QIANWEN_API_KEY" \
            -H 'Content-Type: application/json' \
            -d '{
              "model": "qwen-turbo",
              "input": {
                "messages": [
                  {
                    "role": "user",
                    "content": "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œè¯·å›å¤'æµ‹è¯•æˆåŠŸ'"
                  }
                ]
              },
              "parameters": {
                "result_format": "message"
              }
            }')
          
          # æå–çŠ¶æ€ç å’Œå“åº”ä½“
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "ğŸ“Š HTTP çŠ¶æ€ç : $http_code"
          echo "ğŸ“ å“åº”å†…å®¹ï¼ˆå‰200å­—ç¬¦ï¼‰:"
          echo "$body" | head -c 200
          echo ""
          echo ""
          
          # æ£€æŸ¥ç»“æœ
          if [ "$http_code" = "200" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ç 
            if echo "$body" | grep -q '"code"'; then
              error_code=$(echo "$body" | grep -o '"code":"[^"]*"' | cut -d'"' -f4)
              error_msg=$(echo "$body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4)
              echo "âŒ API è¿”å›é”™è¯¯ï¼š"
              echo "   é”™è¯¯ç : $error_code"
              echo "   é”™è¯¯ä¿¡æ¯: $error_msg"
              echo ""
              echo "å¸¸è§é”™è¯¯ï¼š"
              echo "  - InvalidApiKey: API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ"
              echo "  - Arrearage: è´¦æˆ·æ¬ è´¹"
              echo "  - throttling.RateQuota: è°ƒç”¨é¢‘ç‡è¶…é™"
              exit 1
            else
              echo "âœ… API è°ƒç”¨æˆåŠŸï¼"
              # å°è¯•æå–å›å¤å†…å®¹
              if echo "$body" | grep -q '"content"'; then
                echo ""
                echo "ğŸ“ AI å›å¤:"
                echo "$body" | grep -o '"content":"[^"]*"' | cut -d'"' -f4 | head -1
              fi
              exit 0
            fi
          else
            echo "âŒ HTTP è¯·æ±‚å¤±è´¥ï¼çŠ¶æ€ç : $http_code"
            exit 1
          fi

  summary:
    name: ğŸ“Š é…ç½®æ£€æŸ¥æ€»ç»“
    runs-on: ubuntu-latest
    needs: [test-wecom-notification, test-qianwen-api]
    if: always()
    
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        env:
          WECOM_RESULT: ${{ needs.test-wecom-notification.result }}
          QIANWEN_RESULT: ${{ needs.test-qianwen-api.result }}
        run: |
          echo "## ğŸ§ª é…ç½®æµ‹è¯•æŠ¥å‘Š"
          echo ""
          echo "| é…ç½®é¡¹ | çŠ¶æ€ |"
          echo "|--------|------|"
          
          # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          if [ "$WECOM_RESULT" = "success" ]; then
            echo "| ä¼ä¸šå¾®ä¿¡é€šçŸ¥ | âœ… æ­£å¸¸ |"
          else
            echo "| ä¼ä¸šå¾®ä¿¡é€šçŸ¥ | âŒ å¤±è´¥ |"
          fi
          
          # åƒé—® API
          if [ "$QIANWEN_RESULT" = "success" ]; then
            echo "| åƒé—® API | âœ… æ­£å¸¸ |"
          else
            echo "| åƒé—® API | âŒ å¤±è´¥ |"
          fi
          
          echo ""
          echo "---"
          echo ""
          
          # æ€»ä½“ç»“è®º
          if [ "$WECOM_RESULT" = "success" ] && [ "$QIANWEN_RESULT" = "success" ]; then
            echo "âœ… **æ‰€æœ‰é…ç½®æ­£å¸¸ï¼å¯ä»¥æ­£å¸¸ä½¿ç”¨è‚¡ç¥¨åˆ†æåŠŸèƒ½**"
            exit 0
          else
            echo "âš ï¸ **éƒ¨åˆ†é…ç½®æœ‰é—®é¢˜ï¼Œè¯·æ ¹æ®ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ä¿®å¤**"
            exit 0  # ä¸è®© summary job å¤±è´¥ï¼Œåªæ˜¯æŠ¥å‘ŠçŠ¶æ€
          fi
